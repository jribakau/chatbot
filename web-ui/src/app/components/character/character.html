<div class="character-container">
    <div class="character-layout">
        <div class="character-sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">Characters</h2>
                <button class="btn-create" (click)="startCreate()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Character
                </button>
                <button class="btn-back" (click)="backToChat()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M15 18l-6-6 6-6"></path>
                    </svg>
                    Back to Chat
                </button>
            </div>

            @if (!loading) {
            <div class="character-list">
                @for (character of characters; track character.id) {
                <div class="character-item" [class.active]="selectedCharacter?.id === character.id"
                    (click)="selectCharacter(character)">
                    <div class="character-avatar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="character-info">
                        <div class="character-name">{{ character.name }}</div>
                        <div class="character-description">{{ character.description || 'No description' }}</div>
                    </div>
                </div>
                }

                @if (characters.length === 0) {
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <p>No characters yet</p>
                </div>
                }
            </div>
            }

            @if (loading) {
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading characters...</p>
            </div>
            }
        </div>

        <div class="character-main">
            @if (isCreating || isEditing) {
            <div class="character-form">
                <div class="form-header">
                    <h2>{{ isCreating ? 'Create New Character' : 'Edit Character' }}</h2>
                    <button class="btn-close" (click)="cancelEdit()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <form (ngSubmit)="onCreate()" #characterForm="ngForm" class="form-content">
                    <div class="input-group">
                        <label for="name" class="input-label">Name *</label>
                        <input id="name" type="text" placeholder="Enter character name" required
                            [(ngModel)]="newCharacter.name" name="name" class="input-field" />
                    </div>

                    <div class="input-group">
                        <label for="description" class="input-label">Description</label>
                        <textarea id="description" placeholder="Brief description of the character"
                            [(ngModel)]="newCharacter.description" name="description" class="textarea-field"
                            rows="3"></textarea>
                    </div>

                    <div class="input-group">
                        <label for="systemPrompt" class="input-label">System Prompt</label>
                        <textarea id="systemPrompt"
                            placeholder="Enter the system prompt that defines this character's behavior"
                            [(ngModel)]="newCharacter.systemPrompt" name="systemPrompt" class="textarea-field"
                            rows="6"></textarea>
                    </div>

                    <div class="input-group">
                        <label for="shortGreeting" class="input-label">Short Greeting</label>
                        <input id="shortGreeting" type="text" placeholder="Initial greeting message"
                            [(ngModel)]="newCharacter.shortGreeting" name="shortGreeting" class="input-field" />
                    </div>

                    <div class="custom-fields-section">
                        <div class="section-header">
                            <h3 class="section-title">Custom Fields</h3>
                            <p class="section-subtitle">Add custom attributes like age, ethnicity, hobbies, etc.</p>
                        </div>

                        @if (customFieldsArray.length > 0) {
                        <div class="custom-fields-list">
                            @for (field of customFieldsArray; track $index) {
                            <div class="custom-field-item">
                                <div class="custom-field-inputs">
                                    <input type="text" placeholder="Field name" [(ngModel)]="field.key"
                                        [name]="'fieldKey' + $index" class="input-field field-key" />
                                    <input type="text" placeholder="Field value" [(ngModel)]="field.value"
                                        [name]="'fieldValue' + $index" class="input-field field-value" />
                                </div>
                                <button type="button" class="btn-remove" (click)="removeCustomField($index)"
                                    title="Remove field">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                            }
                        </div>
                        }

                        <div class="add-custom-field">
                            <div class="custom-field-inputs">
                                <input type="text" placeholder="Field name (e.g., Age, Hobbies)"
                                    [(ngModel)]="newFieldKey" name="newFieldKey" class="input-field field-key" />
                                <input type="text" placeholder="Field value" [(ngModel)]="newFieldValue"
                                    name="newFieldValue" class="input-field field-value" />
                            </div>
                            <button type="button" class="btn-add-field" (click)="addCustomField()"
                                [disabled]="!newFieldKey.trim()">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                Add Field
                            </button>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" (click)="cancelEdit()">Cancel</button>
                        <button type="submit" class="btn-primary" [disabled]="!characterForm.valid">
                            {{ isCreating ? 'Create Character' : 'Update Character' }}
                        </button>
                    </div>
                </form>
            </div>
            }

            @if (selectedCharacter && !isCreating && !isEditing) {
            <div class="character-details">
                <div class="details-header">
                    <div class="character-avatar-large">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="details-title-section">
                        <h2 class="details-title">{{ selectedCharacter.name }}</h2>
                        @if (selectedCharacter.description) {
                        <p class="details-subtitle">{{
                            selectedCharacter.description }}</p>
                        }
                    </div>
                    <div class="details-actions">
                        <button class="btn-icon" (click)="startEdit(selectedCharacter)">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="btn-icon btn-danger" (click)="onDelete(selectedCharacter.id!)">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path
                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="details-content">
                    @if (selectedCharacter.systemPrompt) {
                    <div class="detail-section">
                        <h3 class="section-title">System Prompt</h3>
                        <div class="section-content">{{ selectedCharacter.systemPrompt }}</div>
                    </div>
                    }

                    @if (selectedCharacter.shortGreeting) {
                    <div class="detail-section">
                        <h3 class="section-title">Greeting</h3>
                        <div class="section-content">{{ selectedCharacter.shortGreeting }}</div>
                    </div>
                    }

                    @if (selectedCharacter.customFields && getCustomFieldsArray(selectedCharacter.customFields).length >
                    0) {
                    <div class="detail-section">
                        <h3 class="section-title">Custom Fields</h3>
                        <div class="custom-fields-display">
                            @for (field of getCustomFieldsArray(selectedCharacter.customFields); track field.key) {
                            <div class="custom-field-display-item">
                                <span class="field-label">{{ field.key }}:</span>
                                <span class="field-value">{{ field.value }}</span>
                            </div>
                            }
                        </div>
                    </div>
                    }
                </div>
            </div>
            }

            @if (!selectedCharacter && !isCreating && !isEditing) {
            <div class="empty-main-state">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <h3>Select a character</h3>
                <p>Choose a character from the list or create a new one</p>
            </div>
            }
        </div>
    </div>
</div>