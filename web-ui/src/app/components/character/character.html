<div class="character-page">
    <!-- Top Navigation Bar -->
    <app-navbar [userName]="currentUsername || undefined" (logout)="onLogout()" (settings)="toggleSettings()">
    </app-navbar>

    <div class="character-container">
        <div class="character-layout">
            <!-- Sidebar using the new generic component -->
            <app-sidebar class="character-sidebar" title="Characters" [characters]="characters"
                [selectedCharacterId]="selectedCharacter?.id || null" [actions]="sidebarActions" [showPastChats]="false"
                (characterSelected)="onCharacterSelected($event)">
            </app-sidebar>

            <div class="character-main">
                @if (isCreating || isEditing) {
                <div class="character-form">
                    <div class="form-header">
                        <h2>{{ isCreating ? 'Create New Character' : 'Edit Character' }}</h2>
                        <button class="btn-close" (click)="cancelEdit()">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>

                    <form (ngSubmit)="onCreate()" #characterForm="ngForm" class="form-content">
                        <div class="input-group">
                            <label for="name" class="input-label">Name *</label>
                            <input id="name" type="text" placeholder="Enter character name" required
                                [(ngModel)]="newCharacter.name" name="name" class="input-field" />
                        </div>

                        <div class="input-group">
                            <label class="input-label">Profile Image</label>
                            <div class="image-upload-section">
                                @if (imagePreview) {
                                <div class="image-preview">
                                    <img [src]="imagePreview" alt="Profile preview" />
                                    <button type="button" class="btn-remove-preview"
                                        (click)="selectedFile = null; imagePreview = null">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                                }
                                <input type="file" id="profileImage" (change)="onFileSelected($event)"
                                    accept="image/jpeg,image/jpg,image/png,image/webp" class="file-input" />
                                <label for="profileImage" class="file-input-label">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                    {{ imagePreview ? 'Change Image' : 'Choose Image' }}
                                </label>
                                <p class="file-input-hint">JPG, PNG, or WEBP (max 5MB)</p>
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="description" class="input-label">Description</label>
                            <textarea id="description" placeholder="Brief description of the character"
                                [(ngModel)]="newCharacter.description" name="description" class="textarea-field"
                                rows="3"></textarea>
                        </div>

                        <div class="input-group">
                            <label for="systemPrompt" class="input-label">System Prompt</label>
                            <textarea id="systemPrompt"
                                placeholder="Enter the system prompt that defines this character's behavior"
                                [(ngModel)]="newCharacter.systemPrompt" name="systemPrompt" class="textarea-field"
                                rows="6"></textarea>
                        </div>

                        <div class="input-group">
                            <label for="shortGreeting" class="input-label">Short Greeting</label>
                            <input id="shortGreeting" type="text" placeholder="Initial greeting message"
                                [(ngModel)]="newCharacter.shortGreeting" name="shortGreeting" class="input-field" />
                        </div>

                        <div class="custom-fields-section">
                            <div class="section-header">
                                <h3 class="section-title">Custom Fields</h3>
                                <p class="section-subtitle">Add custom attributes like age, ethnicity, hobbies, etc.</p>
                            </div>

                            @if (customFieldsArray.length > 0) {
                            <div class="custom-fields-list">
                                @for (field of customFieldsArray; track $index) {
                                <div class="custom-field-item">
                                    <div class="custom-field-inputs">
                                        <input type="text" placeholder="Field name" [(ngModel)]="field.key"
                                            [name]="'fieldKey' + $index" class="input-field field-key" />
                                        <input type="text" placeholder="Field value" [(ngModel)]="field.value"
                                            [name]="'fieldValue' + $index" class="input-field field-value" />
                                    </div>
                                    <button type="button" class="btn-remove" (click)="removeCustomField($index)"
                                        title="Remove field">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                                }
                            </div>
                            }

                            <div class="add-custom-field">
                                <div class="custom-field-inputs">
                                    <input type="text" placeholder="Field name (e.g., Age, Hobbies)"
                                        [(ngModel)]="newFieldKey" name="newFieldKey" class="input-field field-key" />
                                    <input type="text" placeholder="Field value" [(ngModel)]="newFieldValue"
                                        name="newFieldValue" class="input-field field-value" />
                                </div>
                                <button type="button" class="btn-add-field" (click)="addCustomField()"
                                    [disabled]="!newFieldKey.trim()">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                    Add Field
                                </button>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-secondary" (click)="cancelEdit()">Cancel</button>
                            @if (isEditing && selectedCharacter && selectedCharacter.id) {
                            <button type="button" class="btn-danger" (click)="onDelete(selectedCharacter.id)">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" style="width: 16px; height: 16px;">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                    </path>
                                </svg>
                                Delete
                            </button>
                            }
                            <button type="submit" class="btn-primary" [disabled]="!characterForm.valid">
                                {{ isCreating ? 'Create Character' : 'Update Character' }}
                            </button>
                        </div>
                    </form>
                </div>
                }

                @if (!isCreating && !isEditing) {
                <div class="empty-main-state">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <h3>Select a character</h3>
                    <p>Choose a character from the list or create a new one</p>
                </div>
                }
            </div>
        </div>
    </div>
</div>